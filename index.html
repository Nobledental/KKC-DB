<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KCC Professional Billing System</title>
    
    <!-- Tailwind CSS (Utility classes) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Local Decimal.js for precise calculations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js"></script>
    
    <!-- Fonts: Inter for clean, modern legibility -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --primary-blue: #1e3a8a; /* Deep Blue */
            --header-bg: #f3f4f6;    /* Light Gray for Section Headers */
            --border-color: #e5e7eb;
            --text-main: #1f2937;
            --text-muted: #6b7280;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #eef2f6; 
            color: var(--text-main);
            font-size: 13px; /* Slightly smaller base font for compactness */
            -webkit-font-smoothing: antialiased;
        }

        /* --- CSS: LAYOUT & COMPONENTS --- */
        .container-main { 
            max-width: 210mm; /* A4 Width */
            margin: 20px auto;
            background: white;
            min-height: 297mm; /* A4 Height */
        }

        .section-header {
            background-color: var(--header-bg);
            border-bottom: 1px solid #d1d5db;
            color: #111827;
            font-weight: 700;
            padding: 4px 12px; /* Reduced padding */
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        /* Grid for Bill Rows: Adjusted to remove Gross Column */
        /* SNo(30) Date(70) Desc(Auto) Rate(70) Qty(30) Disc(60) Total(80) Action(30) */
        .bill-grid-header, .bill-grid-row {
            display: grid;
            grid-template-columns: 30px 70px 1fr 70px 30px 60px 80px 30px; 
            gap: 4px; /* Reduced gap */
            align-items: center;
        }

        .bill-grid-header {
            border-bottom: 2px solid #000;
            padding: 6px 12px;
            font-weight: 700;
            font-size: 11px;
            text-transform: uppercase;
            color: #374151;
        }

        .bill-grid-row {
            padding: 4px 12px; /* Reduced padding for compact rows */
            border-bottom: 1px solid #f3f4f6;
            font-size: 12px;
        }
        
        /* Alignments */
        .text-right-col { text-align: right; justify-content: flex-end; display: flex; }
        .text-left-col { text-align: left; justify-content: flex-start; display: flex; }
        
        .bill-grid-row .text-right-col { font-variant-numeric: tabular-nums; }

        /* Input Styling */
        input, select { 
            border: 1px solid #d1d5db; 
            border-radius: 4px; 
            padding: 2px 6px; 
            font-size: 12px; 
            width: 100%;
            transition: border-color 0.15s;
        }
        input:focus, select:focus { outline: none; border-color: var(--primary-blue); box-shadow: 0 0 0 2px rgba(30, 58, 138, 0.1); }
        .input-financial { text-align: right; font-family: 'Courier New', monospace; font-weight: 600; }
        
        /* Editable Description Input Style */
        .input-desc-edit {
            border: 1px solid transparent;
            padding: 1px 4px;
            background: transparent;
            width: 100%;
            font-weight: 500;
            color: #1f2937;
        }
        .input-desc-edit:hover { border: 1px solid #e5e7eb; background: #fff; }
        .input-desc-edit:focus { border: 1px solid var(--primary-blue); background: #fff; }

        /* Category Group Header in Table */
        .category-row {
            grid-column: 1 / -1;
            background-color: #f9fafb;
            font-weight: 700;
            font-size: 10px;
            padding: 2px 12px;
            border-bottom: 1px solid #e5e7eb;
            color: var(--primary-blue);
            text-transform: uppercase;
            margin-top: 2px;
        }

        /* --- CSS: PRINT MEDIA QUERY --- */
        @media print {
            @page { size: A4; margin: 10mm; }
            
            body { 
                background: white; 
                font-size: 10pt; 
                color: black !important; /* Force Black Text */
            }
            
            /* Force all text to black including headers and totals */
            .text-red-600, .text-blue-600, .text-gray-500, .text-gray-900 {
                color: black !important;
            }

            .container-main {
                box-shadow: none;
                margin: 0;
                width: 100%;
                max-width: 100%;
                min-height: auto;
            }

            .no-print { display: none !important; }

            /* Print Aesthetics */
            .section-header { 
                background-color: #f3f4f6 !important; 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
                border-top: 1px solid #000;
                border-bottom: 1px solid #000;
            }

            /* Grid Adjustments for Print (Hide Action Column) */
            .bill-grid-header, .bill-grid-row {
                grid-template-columns: 30px 70px 1fr 70px 30px 60px 80px 0px;
            }
            .bill-grid-row > div:last-child { display: none; } /* Hide 'X' button container */

            /* Hide Inputs, Show Values */
            input, select { display: none !important; }
            .print-value-display { display: inline-block !important; }
            
            /* Ensure editable description prints correctly */
            .input-desc-edit { display: none !important; }
            .print-desc-display { display: inline-block !important; width: 100%; }
            
            /* Clean Table Lines */
            .bill-grid-header { border-bottom: 2px solid #000 !important; }
            .bill-grid-row { border-bottom: 1px solid #eee !important; }

            /* Footer Positioning */
            footer {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                text-align: center;
                font-size: 8pt;
                color: black !important;
                border-top: 1px solid #000;
                padding-top: 8px;
            }
            
            /* Compact Spacing for Print */
            .p-8 { padding: 1.5rem !important; }
            .mb-6 { margin-bottom: 1rem !important; }
            .gap-8 { gap: 1rem !important; }
            
            /* Standardize Font Sizes in Summary */
            #financialSummarySection .text-lg, 
            #financialSummarySection .text-2xl,
            #financialSummarySection .text-base {
                font-size: 10pt !important; /* Force same font size */
            }
        }
    </style>
</head>
<body>

    <!-- SETTINGS MODAL (Admin) -->
    <div id="tariffModal" class="no-print hidden-admin fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-2xl w-[600px] max-h-[80vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                <h2 class="font-bold text-gray-800">Tariff Master Configuration</h2>
                <button onclick="toggleTariffAdmin()" class="text-gray-400 hover:text-red-500 text-2xl">&times;</button>
            </div>
            <div id="tariffBody" class="p-6 overflow-y-auto grid grid-cols-2 gap-4"></div>
            <div class="p-4 border-t bg-gray-50 text-right rounded-b-lg">
                <button onclick="toggleTariffAdmin()" class="px-4 py-2 bg-gray-800 text-white rounded text-xs font-bold">CLOSE</button>
            </div>
        </div>
    </div>

    <!-- MAIN A4 PAGE -->
    <div class="container-main shadow-lg rounded-sm flex flex-col relative">
        
        <!-- HEADER -->
        <header class="p-8 pb-2">
            <div class="flex justify-between items-start">
                <div class="flex items-center gap-4">
                    <!-- HOSPITAL LOGO (SVG) -->
                    <div class="w-16 h-16 text-[#1e3a8a] flex items-center justify-center">
                        <svg viewBox="0 0 24 24" fill="currentColor" class="w-14 h-14">
                            <path d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3M18 11H14V15H10V11H6V9H10V5H14V9H18V11Z" />
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-black text-gray-900 tracking-tight leading-none">KRISHNA KIDNEY CENTRE</h1>
                        <p class="text-sm text-gray-500 mt-1 font-medium">Krishnagiri, Tamil Nadu • India</p>
                    </div>
                </div>
                <div class="text-right">
                    <span class="inline-block bg-blue-600 text-white text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wider mb-2 print:bg-white print:text-black print:border print:border-black">
                        Discharge Final Bill
                    </span>
                    <div class="text-sm">Bill No: <span id="b_invoice_no" class="font-bold text-red-600">PROVISIONAL</span></div>
                    <div class="text-sm text-gray-500">Run Date: <span id="b_run_date" class="font-medium text-gray-900"></span></div>
                </div>
            </div>
            <hr class="mt-4 border-gray-200">
        </header>

        <!-- CONTROLS (Screen Only) -->
        <div class="px-8 mb-2 no-print flex gap-2">
            <button onclick="generateNewIDs()" class="bg-amber-500 hover:bg-amber-600 text-white text-xs font-bold px-3 py-2 rounded">GENERATE IDS</button>
            <button onclick="newBill()" class="bg-red-500 hover:bg-red-600 text-white text-xs font-bold px-3 py-2 rounded">CLEAR FORM</button>
            <button onclick="toggleTariffAdmin()" class="bg-gray-700 hover:bg-gray-800 text-white text-xs font-bold px-3 py-2 rounded ml-auto">SETTINGS</button>
        </div>

        <!-- PATIENT DETAILS SECTION -->
        <div class="px-8 mb-4">
            <div class="section-header rounded-t-sm">Patient & General Details</div>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-x-8 gap-y-2 p-3 border border-t-0 border-gray-200 text-xs">
                <!-- Row 1 -->
                <div>
                    <label class="block text-[9px] font-bold text-gray-400 uppercase tracking-wider mb-1">UHID</label>
                    <input type="text" id="ui_uhid" class="no-print-border" oninput="renderUI()">
                    <span class="print-value-display hidden font-bold text-gray-800" id="print_uhid"></span>
                </div>
                <div>
                    <label class="block text-[9px] font-bold text-gray-400 uppercase tracking-wider mb-1">IP Number</label>
                    <input type="text" id="ui_ip" class="no-print-border" oninput="renderUI()">
                    <span class="print-value-display hidden font-bold text-gray-800" id="print_ip"></span>
                </div>
                <div>
                    <label class="block text-[9px] font-bold text-gray-400 uppercase tracking-wider mb-1">Patient Name</label>
                    <input type="text" id="ui_name" class="font-bold" oninput="renderUI()">
                    <span class="print-value-display hidden font-bold text-gray-800 text-sm" id="print_name"></span>
                </div>

                <!-- Row 2 -->
                <div>
                    <label class="block text-[9px] font-bold text-gray-400 uppercase tracking-wider mb-1">Admission Date</label>
                    <input type="date" id="ui_doa" oninput="renderUI()">
                    <span class="print-value-display hidden font-medium text-gray-800" id="print_doa"></span>
                </div>
                <div>
                    <label class="block text-[9px] font-bold text-gray-400 uppercase tracking-wider mb-1">Discharge Date</label>
                    <input type="date" id="ui_dod" oninput="renderUI()">
                    <span class="print-value-display hidden font-medium text-gray-800" id="print_dod"></span>
                </div>
                <div>
                    <label class="block text-[9px] font-bold text-gray-400 uppercase tracking-wider mb-1">Room Category</label>
                    <select id="ui_roomCat" onchange="renderUI()"></select>
                    <span class="print-value-display hidden font-medium text-gray-800" id="print_roomCat"></span>
                    <button onclick="addRoomDays()" class="no-print mt-1 text-[9px] text-blue-600 underline hover:text-blue-800">Auto-Calc</button>
                </div>

                <!-- Row 3 -->
                <div>
                    <label class="block text-[9px] font-bold text-gray-400 uppercase tracking-wider mb-1">Consultant</label>
                    <select id="ui_doc" onchange="renderUI()"></select>
                    <span class="print-value-display hidden font-medium text-gray-800" id="print_doc"></span>
                </div>
                <div>
                    <label class="block text-[9px] font-bold text-gray-400 uppercase tracking-wider mb-1">Insurance / Payer</label>
                    <input type="text" id="ui_insurance" oninput="renderUI()">
                    <span class="print-value-display hidden font-medium text-gray-800" id="print_insurance"></span>
                </div>
            </div>
        </div>

        <!-- BILLING ITEMS TABLE -->
        <div class="px-8 flex-grow">
            <div class="section-header rounded-t-sm">Billing Items</div>
            
            <div class="bill-grid-header bg-gray-50">
                <div class="text-left-col">S.No</div>
                <div class="text-left-col">Date</div>
                <div class="text-left-col">Description</div>
                <div class="text-right-col">Rate</div>
                <div class="text-right-col">Qty</div>
                <div class="text-right-col">Disc.</div>
                <div class="text-right-col">Total</div>
                <div class="text-center no-print">Act</div>
            </div>

            <div id="ui_billBody" class="border-l border-r border-b border-gray-200 min-h-[150px] pb-4">
                <!-- JS will inject rows here -->
            </div>

            <!-- MANUAL ADD (No Print) -->
            <div class="no-print mt-2 p-2 bg-blue-50 border border-blue-100 rounded text-xs">
                <div class="flex gap-2 items-end">
                    <div class="flex-1">
                        <label class="text-[9px] text-gray-500 font-bold uppercase">Category</label>
                        <select id="ui_cat" class="bg-white"></select>
                    </div>
                    <div class="flex-[2]">
                        <label class="text-[9px] text-gray-500 font-bold uppercase">Description</label>
                        <input type="text" id="ui_desc" class="bg-white" placeholder="Type description...">
                    </div>
                    <div class="w-16">
                        <label class="text-[9px] text-gray-500 font-bold uppercase">Rate</label>
                        <input type="number" id="ui_rate" class="bg-white">
                    </div>
                    <div class="w-12">
                        <label class="text-[9px] text-gray-500 font-bold uppercase">Qty</label>
                        <input type="number" id="ui_qty" value="1" class="bg-white">
                    </div>
                    <button onclick="addItem()" class="bg-blue-600 text-white font-bold text-xs px-3 py-1.5 rounded">ADD</button>
                    <button onclick="clearBillingItems()" class="bg-white border border-red-200 text-red-600 font-bold text-xs px-2 py-1.5 rounded">CLR</button>
                </div>
            </div>
        </div>

        <!-- SUMMARY SECTION -->
        <div class="px-8 mt-2 mb-20" id="financialSummarySection">
            <div class="grid grid-cols-2 gap-8">
                
                <!-- LEFT: Receipts (Hidden in print if needed, but keeping logic) -->
                <div>
                    <div class="section-header rounded-t-sm">Receipts & Payments</div>
                    <div class="border border-t-0 border-gray-200 p-3 min-h-[100px] flex flex-col justify-between">
                        <div id="receiptLines" class="space-y-1 text-xs"></div>
                        
                        <div class="no-print mt-2 pt-2 border-t border-dashed border-gray-200">
                            <div class="flex gap-2 mb-2">
                                <input type="text" id="ui_rno" placeholder="R.No" class="w-20">
                                <input type="number" id="ui_ramt" placeholder="Amount" class="w-24 font-bold text-blue-800">
                                <input type="date" id="ui_rdate" class="w-24">
                            </div>
                            <div class="flex gap-2">
                                <select id="ui_rmode" class="w-20"><option>Cash</option><option>Card</option><option>UPI</option></select>
                                <button onclick="addReceipt()" class="bg-green-600 text-white text-xs font-bold px-3 py-1 rounded flex-grow">ADD PAYMENT</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT: Financial Summary -->
                <div>
                    <div class="section-header rounded-t-sm">Financial Summary</div>
                    <div class="border border-t-0 border-gray-200 p-3">
                        <div class="flex justify-between items-center mb-1 no-print">
                            <span class="text-xs text-gray-500">Global Discount (%)</span>
                            <input type="number" id="ui_billDiscount" value="0" class="w-16 text-right font-bold text-red-600" oninput="renderUI()">
                        </div>

                        <div class="space-y-2 text-sm">
                            <!-- ONLY SHOW Total Gross, Final Bill, Balance Due -->
                            
                            <div class="flex justify-between">
                                <span class="text-gray-600 font-bold">Total Gross Amount</span>
                                <span class="font-bold font-mono" id="ui_s_gross">0.00</span>
                            </div>
                            
                            <!-- Hidden rows (still in DOM for logic but hidden visually) -->
                            <div class="flex justify-between text-red-600 text-xs hidden">
                                <span>Item Discounts</span>
                                <span class="font-mono" id="ui_itemDiscount">- 0.00</span>
                            </div>
                            <div class="flex justify-between text-red-600 text-xs border-b border-gray-100 pb-2 hidden">
                                <span>Global Discount Applied</span>
                                <span class="font-mono" id="ui_globalDiscount">- 0.00</span>
                            </div>

                            <!-- Final Bill Amount -->
                            <div class="flex justify-between items-center pt-1 border-t border-gray-100">
                                <span class="font-bold text-gray-800">Final Bill Amount</span>
                                <span class="font-bold font-mono text-base" id="ui_s_net_bill">0.00</span>
                            </div>

                            <div class="hidden flex justify-between items-center bg-gray-50 p-2 rounded border border-gray-200 mt-2">
                                <span class="font-black text-gray-900 uppercase">**Grand Total**</span>
                                <span class="font-black font-mono text-lg text-gray-900" id="ui_s_grand_total">0.00</span>
                            </div>

                            <div class="hidden flex justify-between text-gray-600 pt-2">
                                <span>Less: Receipts Paid</span>
                                <span class="font-mono" id="ui_s_rec">0.00</span>
                            </div>

                            <!-- Balance Due -->
                            <div class="flex justify-between items-center pt-2 border-t-2 border-gray-300 mt-2">
                                <span class="font-black text-red-600 text-lg uppercase">Balance Due</span>
                                <span class="font-black font-mono text-2xl text-red-600" id="ui_s_final">0.00</span>
                            </div>
                        </div>
                        
                        <div class="mt-4 text-right no-print">
                            <button onclick="preparePrint()" class="bg-[#1e3a8a] text-white font-bold px-4 py-2 rounded shadow hover:bg-blue-900 transition flex items-center gap-2 justify-center w-full text-xs">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                                PRINT FINAL INVOICE
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SIGNATURE SECTION (Added as requested) -->
        <div class="px-8 mt-auto mb-4">
            <div class="flex justify-between items-end pt-8 pb-4">
                <div class="text-center">
                    <div class="w-40 border-t border-black mb-1"></div>
                    <div class="font-bold text-xs uppercase">Prepared By</div>
                </div>
                <div class="text-center">
                    <div class="w-40 border-t border-black mb-1"></div>
                    <div class="font-bold text-xs uppercase">Staff Signature</div>
                </div>
            </div>
        </div>

        <!-- FOOTER -->
        <footer class="py-4 border-t border-gray-200 text-center text-gray-500 text-[9px]">
            <div class="font-bold text-gray-700 uppercase mb-1">Krishna Kidney Centre</div>
            <div>123 Main Street, Near Bus Stand, Krishnagiri - 635001, Tamil Nadu, India</div>
            <div>Phone: +91 4343-22XXXX | Email: info@krishnakidneycentre.com</div>
            <div class="mt-1 text-gray-400 italic">This is a computer generated invoice. Signature is not required.</div>
        </footer>

    </div>

    <!-- --- JAVASCRIPT LOGIC --- -->
    <script type="module">
        // 1. DECIMAL CONFIG
        if (typeof Decimal === 'undefined') {
            window.Decimal = class {
                constructor(value) { this.v = Number(value || 0); }
                toNumber() { return this.v; }
                plus(other) { return new Decimal(this.v + new Decimal(other).toNumber()); }
                mul(other) { return new Decimal(this.v * new Decimal(other).toNumber()); }
                div(other) { return new Decimal(this.v / new Decimal(other).toNumber()); }
                minus(other) { return new Decimal(this.v - new Decimal(other).toNumber()); }
                lte(other) { return this.v <= new Decimal(other).toNumber(); }
                gt(other) { return this.v > new Decimal(other).toNumber(); }
                toFixed(d) { return this.v.toFixed(d); }
            };
        } else {
            window.Decimal = Decimal;
        }

        // 2. DATA CONSTANTS
        window.TARIFF = {
            currency: "INR",
            opd_charges: { CONSULTATION: { name: "General Consultation", rate: 500 }, SPECIALIST: { name: "Super Specialist Visit", rate: 1000 } },
            rooms: {
                "SINGLE AC": { tariff: 3500, nursing: 750, consultant: 800 },
                "GENERAL WARD": { tariff: 2500, nursing: 750, consultant: 800 },
                "GW": { tariff: 2000, nursing: 500, consultant: 500 },
                "PVT": { tariff: 4000, nursing: 1000, consultant: 1000 },
                "ICU": { tariff: 6000, nursing: 2000, consultant: 2000 }
            },
            // Flat list of categories added to TARIFF keys to appear in dropdown
            "SURGEON FEES": { default: { rate: 0 } },
            "ASSISTANT SURGEON FEES": { default: { rate: 0 } },
            "DJ STENTING": { default: { rate: 0 } },
            "ANAESTHESIA FEES": { default: { rate: 0 } },
            "ICU CHARGE": { default: { rate: 0 } },
            "DOCTOR CHARGE": { default: { rate: 0 } },
            "SPECIALTY DOCTOR ICU VISIT CHARGE": { default: { rate: 0 } },
            "BED CHARGE": { default: { rate: 0 } },
            "NURSING CHARGES": { default: { rate: 0 } },
            "OT CHARGE": { default: { rate: 0 } },
            "PREANESTHETIC CHECKUP": { default: { rate: 0 } },
            "MEDICINE CHARGE": { default: { rate: 0 } },

            doctors: ["Dr. B.K. Srinivasan", "Dr. Rajesh", "Dr. Anjali"],
            surgical_packages: {
                URO: { 
                    TURP: { "GENERAL WARD": 54000, "SINGLE AC": 67500, breakup: { "Surgeon": 0.6, "OT": 0.25, "Anesthesia": 0.15 } }
                }
            },
            investigations: { CBC: { name: "Complete Blood Count", rate: 450 }, CREATININE: { name: "Serum Creatinine", rate: 250 } },
            pharmacy: { PARA500: { name: "Paracetamol 500mg", rate: 2 }, ANTIBIOTIC: { name: "Antibiotic Inj", rate: 450 } },
            miscellaneous: { MRD: { name: "MRD Charges", rate: 500 }, ADMISSION: { name: "Admission Fee", rate: 250 } }
        };
        
        window.billItems = [];
        window.receipts = [];
        const STORAGE_KEY = 'kcc_bill_data';

        // 3. CORE FUNCTIONS
        function formatMoney(amount) {
            // CHANGED: Removed Commas, simple fixed decimal
            return new Decimal(amount).toFixed(2);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }).toUpperCase();
        }

        function generateUniqueBillNo() {
            // CHANGED: 12-digit alphanumeric unique sequence
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 12; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function calculateTotals() {
            let gross = new Decimal(0);
            let totalItemDisc = new Decimal(0);
            let netAfterItemDisc = new Decimal(0);

            // Item Level Calcs
            window.billItems.forEach(item => {
                const g = new Decimal(item.rate).mul(item.qty);
                const d = new Decimal(item.discount || 0);
                
                item.gross = g.toFixed(2);
                item.total = g.minus(d).toFixed(2);
                
                gross = gross.plus(g);
                totalItemDisc = totalItemDisc.plus(d);
                netAfterItemDisc = netAfterItemDisc.plus(g.minus(d));
            });

            // Global Discount
            const globalDiscPercent = new Decimal(document.getElementById('ui_billDiscount').value || 0);
            let globalDiscVal = new Decimal(0);
            if(globalDiscPercent.gt(0)) {
                globalDiscVal = netAfterItemDisc.mul(globalDiscPercent.div(100));
            }

            const finalBill = netAfterItemDisc.minus(globalDiscVal);
            
            // Receipts
            let totalPaid = new Decimal(0);
            window.receipts.forEach(r => totalPaid = totalPaid.plus(r.amount));
            
            const balance = finalBill.minus(totalPaid);

            // Update DOM Summary
            document.getElementById('ui_s_gross').innerText = formatMoney(gross.toNumber());
            document.getElementById('ui_itemDiscount').innerText = "- " + formatMoney(totalItemDisc.toNumber());
            document.getElementById('ui_globalDiscount').innerText = "- " + formatMoney(globalDiscVal.toNumber());
            document.getElementById('ui_s_net_bill').innerText = formatMoney(finalBill.toNumber());
            document.getElementById('ui_s_grand_total').innerText = formatMoney(finalBill.toNumber());
            document.getElementById('ui_s_rec').innerText = formatMoney(totalPaid.toNumber());
            document.getElementById('ui_s_final').innerText = formatMoney(balance.toNumber());
        }

        function renderUI() {
            // 1. Update Patient Display (For Print)
            const fields = ['uhid', 'ip', 'name', 'doa', 'dod', 'roomCat', 'doc', 'insurance'];
            fields.forEach(f => {
                const val = document.getElementById('ui_' + f).value;
                const display = document.getElementById('print_' + f);
                if (display) {
                    display.innerText = (f === 'doa' || f === 'dod') ? formatDate(val) : val;
                }
            });
            
            // NEW: Update Run Date to match Discharge Date
            const dodVal = document.getElementById('ui_dod').value;
            document.getElementById('b_run_date').innerText = formatDate(dodVal);

            // 2. Render Bill Items
            const tbody = document.getElementById('ui_billBody');
            tbody.innerHTML = '';
            
            // Sort items by Category then Date
            const sortedItems = [...window.billItems].sort((a, b) => a.category.localeCompare(b.category) || a.date.localeCompare(b.date));
            
            let currentCat = null;
            let sno = 1;

            sortedItems.forEach((item, idx) => {
                // Group Header
                if (item.category !== currentCat) {
                    currentCat = item.category;
                    tbody.innerHTML += `<div class="category-row">${currentCat}</div>`;
                }

                const originalIdx = window.billItems.indexOf(item); // To delete/edit correctly
                
                const row = document.createElement('div');
                row.className = 'bill-grid-row group hover:bg-blue-50';
                row.innerHTML = `
                    <div class="text-left-col text-gray-500">${sno++}</div>
                    <div class="text-left-col">${formatDate(item.date)}</div>
                    
                    <div class="text-left-col">
                        <!-- Editable Description Input -->
                        <input type="text" class="input-desc-edit" value="${item.desc}" onchange="updateItemDesc(${originalIdx}, this.value)">
                        <span class="print-desc-display hidden">${item.desc}</span>
                    </div>

                    <div class="text-right-col">${parseFloat(item.rate).toFixed(2)}</div>
                    <div class="text-right-col">${item.qty}</div>
                    
                    <div class="text-right-col">
                        <input type="number" class="input-financial w-full h-6 text-xs no-print" 
                            value="${item.discount}" onchange="updateItemDisc(${originalIdx}, this.value)">
                        <span class="print-value-display hidden">${item.discount > 0 ? item.discount : '-'}</span>
                    </div>
                    
                    <div class="text-right-col font-bold text-gray-900">${item.total}</div>
                    
                    <div class="text-center no-print">
                        <button onclick="deleteItem(${originalIdx})" class="text-red-400 hover:text-red-600 font-bold">×</button>
                    </div>
                `;
                tbody.appendChild(row);
            });

            // 3. Render Receipts
            const rContainer = document.getElementById('receiptLines');
            rContainer.innerHTML = window.receipts.map((r, i) => `
                <div class="flex justify-between border-b border-dashed border-gray-200 py-1">
                    <span>${r.no} <span class="text-gray-400 text-[10px]">(${formatDate(r.date)})</span> <span class="bg-gray-100 px-1 rounded text-[10px]">${r.mode}</span></span>
                    <span class="font-bold">₹${r.amount} <button onclick="deleteReceipt(${i})" class="ml-2 text-red-500 no-print">×</button></span>
                </div>
            `).join('');

            calculateTotals();
            saveData();
        }

        // 4. ACTION FUNCTIONS
        window.addItem = function() {
            const cat = document.getElementById('ui_cat').value;
            // CHANGED: Get value from input instead of select
            const desc = document.getElementById('ui_desc').value;
            const rate = document.getElementById('ui_rate').value;
            const qty = document.getElementById('ui_qty').value;
            const date = document.getElementById('ui_doa').value; // Default to admission date

            if(!rate || !qty) return;

            window.billItems.push({
                category: cat,
                desc: desc,
                rate: rate,
                qty: qty,
                date: date,
                discount: 0
            });
            renderUI();
        };

        window.updateItemDisc = function(idx, val) {
            window.billItems[idx].discount = val;
            renderUI();
        };
        
        // New Function to handle description edits
        window.updateItemDesc = function(idx, val) {
            window.billItems[idx].desc = val;
            // No need to re-render UI completely for text change to avoid focus loss, 
            // but we call saveData.
            saveData();
        };

        window.deleteItem = function(idx) {
            window.billItems.splice(idx, 1);
            renderUI();
        };

        window.addReceipt = function() {
            const rno = document.getElementById('ui_rno').value;
            const amt = document.getElementById('ui_ramt').value;
            const date = document.getElementById('ui_rdate').value;
            const mode = document.getElementById('ui_rmode').value;

            if(!amt || !rno) return;

            window.receipts.push({ no: rno, amount: parseFloat(amt), date: date, mode: mode });
            document.getElementById('ui_ramt').value = '';
            renderUI();
        };

        window.deleteReceipt = function(idx) {
            window.receipts.splice(idx, 1);
            renderUI();
        };

        window.addRoomDays = function() {
            const roomType = document.getElementById('ui_roomCat').value;
            const start = new Date(document.getElementById('ui_doa').value);
            const end = new Date(document.getElementById('ui_dod').value);
            
            if(isNaN(start) || isNaN(end)) return alert("Set Dates first");

            const roomData = window.TARIFF.rooms[roomType];
            if(!roomData) return;

            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
            
            for(let i=0; i < days; i++) {
                let d = new Date(start);
                d.setDate(d.getDate() + i);
                const dateStr = d.toISOString().split('T')[0];

                window.billItems.push(
                    { category: "Room Rent", desc: `Room Charge: ${roomType}`, rate: roomData.tariff, qty: 1, date: dateStr, discount: 0 },
                    { category: "Nursing", desc: "Nursing Charges", rate: roomData.nursing, qty: 1, date: dateStr, discount: 0 },
                    { category: "Doctor Visit", desc: "Consultant Visits", rate: roomData.consultant * 2, qty: 1, date: dateStr, discount: 0 }
                );
            }
            renderUI();
        };

        // 5. SETUP & HELPERS
        function saveData() {
            const data = {
                items: window.billItems,
                receipts: window.receipts,
                patient: {
                    uhid: document.getElementById('ui_uhid').value,
                    name: document.getElementById('ui_name').value,
                }
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        window.generateNewIDs = function() {
            document.getElementById('ui_uhid').value = "KCC" + Math.floor(Math.random() * 10000);
            document.getElementById('ui_ip').value = "IP" + Math.floor(Math.random() * 10000);
            // CHANGED: Use new generator function
            document.getElementById('b_invoice_no').innerText = generateUniqueBillNo();
            renderUI();
        };

        window.preparePrint = function() {
            document.title = "Bill_" + document.getElementById('ui_name').value;
            setTimeout(() => window.print(), 100);
        };

        window.newBill = function() {
            if(confirm("Clear current bill?")) {
                window.billItems = [];
                window.receipts = [];
                document.querySelectorAll('input').forEach(i => i.value = '');
                renderUI();
            }
        };

        // 6. INITIALIZATION
        (function init() {
            // Populate Dropdowns
            const catSel = document.getElementById('ui_cat');
            Object.keys(window.TARIFF).forEach(k => {
                 // Expanded list to include new keys
                 if(['opd_charges', 'rooms', 'investigations', 'pharmacy', 'miscellaneous',
                    'SURGEON FEES', 'ASSISTANT SURGEON FEES', 'DJ STENTING', 'ANAESTHESIA FEES',
                    'ICU CHARGE', 'DOCTOR CHARGE', 'SPECIALTY DOCTOR ICU VISIT CHARGE', 'BED CHARGE',
                    'NURSING CHARGES', 'OT CHARGE', 'PREANESTHETIC CHECKUP', 'MEDICINE CHARGE'
                    ].includes(k)) {
                     const opt = document.createElement('option');
                     opt.value = k;
                     opt.text = k.toUpperCase().replace('_', ' ');
                     catSel.add(opt);
                 }
            });
            
            // Populate Rooms
            const roomSel = document.getElementById('ui_roomCat');
            Object.keys(window.TARIFF.rooms).forEach(k => {
                const opt = document.createElement('option');
                opt.value = k;
                opt.text = k;
                roomSel.add(opt);
            });

            // Populate Doctors
            const docSel = document.getElementById('ui_doc');
            window.TARIFF.doctors.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d;
                opt.text = d;
                docSel.add(opt);
            });

            // Dynamic Description Loader - MODIFIED
            catSel.addEventListener('change', (e) => {
                // Auto-fill Description text input with the Category Name
                // This is helpful since the user has to manual edit descriptions now
                const descInput = document.getElementById('ui_desc');
                descInput.value = e.target.value; 
            });
            
            // Trigger first load
            // catSel.dispatchEvent(new Event('change')); 

            // Set Dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('ui_doa').value = today;
            document.getElementById('ui_dod').value = today;
            document.getElementById('ui_rdate').value = today;
            
            generateNewIDs();
            renderUI();
        })();

        // Admin Toggles
        window.toggleTariffAdmin = () => document.getElementById('tariffModal').classList.toggle('hidden');
        window.clearBillingItems = () => { window.billItems = []; renderUI(); };
    </script>
</body>
</html>
