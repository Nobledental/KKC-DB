<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KCC Professional Billing System</title>
    
    <!-- Tailwind CSS (Utility classes) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Local Decimal.js for precise calculations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js"></script>
    
    <!-- Fonts: Inter for clean, modern legibility -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --primary-blue: #1e3a8a; /* Deep Blue */
            --header-bg: #f3f4f6;    /* Light Gray for Section Headers */
            --border-color: #e5e7eb;
            --text-main: #1f2937;
            --text-muted: #6b7280;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #eef2f6; 
            color: var(--text-main);
            font-size: 13px;
            -webkit-font-smoothing: antialiased;
        }

        /* --- CSS: LAYOUT & COMPONENTS --- */
        .container-main { 
            max-width: 210mm; /* A4 Width */
            margin: 20px auto;
            background: white;
            min-height: 297mm; /* A4 Height */
        }

        .section-header {
            background-color: var(--header-bg);
            border-bottom: 1px solid #d1d5db;
            color: #111827;
            font-weight: 700;
            padding: 4px 12px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        /* Grid for Bill Rows */
        .bill-grid-header, .bill-grid-row {
            display: grid;
            grid-template-columns: 30px 70px 1fr 70px 30px 60px 80px 30px; 
            gap: 4px;
            align-items: center;
        }

        .bill-grid-header {
            border-bottom: 2px solid #000;
            padding: 6px 12px;
            font-weight: 700;
            font-size: 11px;
            text-transform: uppercase;
            color: #374151;
        }

        .bill-grid-row {
            padding: 4px 12px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 12px;
        }
        
        .bill-grid-row .text-right-col { text-align: right; justify-content: flex-end; display: flex; font-variant-numeric: tabular-nums; }
        .bill-grid-row .text-left-col { text-align: left; justify-content: flex-start; display: flex; }

        /* Input Styling */
        input, select { 
            border: 1px solid #d1d5db; 
            border-radius: 4px; 
            padding: 2px 6px; 
            font-size: 12px; 
            width: 100%;
            transition: border-color 0.15s;
        }
        input:focus, select:focus { outline: none; border-color: var(--primary-blue); box-shadow: 0 0 0 2px rgba(30, 58, 138, 0.1); }
        .input-financial { text-align: right; font-family: 'Courier New', monospace; font-weight: 600; }
        
        /* Editable Description Input Style */
        .input-desc-edit {
            border: 1px solid transparent;
            padding: 1px 4px;
            background: transparent;
            width: 100%;
            font-weight: 500;
            color: #1f2937;
        }
        .input-desc-edit:hover { border: 1px solid #e5e7eb; background: #fff; }
        .input-desc-edit:focus { border: 1px solid var(--primary-blue); background: #fff; }

        /* Category Group Header */
        .category-row {
            grid-column: 1 / -1;
            background-color: #f9fafb;
            font-weight: 700;
            font-size: 10px;
            padding: 2px 12px;
            border-bottom: 1px solid #e5e7eb;
            color: var(--primary-blue);
            text-transform: uppercase;
            margin-top: 2px;
        }

        /* Navigation Tabs */
        .nav-tab {
            padding: 8px 16px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #6b7280;
        }
        .nav-tab.active {
            border-bottom-color: var(--primary-blue);
            color: var(--primary-blue);
        }

        /* --- CSS: PRINT MEDIA QUERY --- */
        @media print {
            @page { size: A4; margin: 10mm; }
            body { 
                background: white; 
                font-size: 10pt; 
                color: black !important; 
                display: block !important; /* Fix for Flexbox print issues */
            }
            .text-red-600, .text-blue-600, .text-gray-500, .text-gray-900 { color: black !important; }
            .container-main { 
                box-shadow: none; 
                margin: 0; 
                width: 100%; 
                max-width: 100%; 
                min-height: auto; 
                display: block !important; /* Fix for Flexbox print issues */
            }
            .no-print { display: none !important; }
            
            .section-header { background-color: #f3f4f6 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; border-top: 1px solid #000; border-bottom: 1px solid #000; }
            
            .bill-grid-header, .bill-grid-row { grid-template-columns: 30px 70px 1fr 70px 30px 60px 80px 0px; }
            .bill-grid-row > div:last-child { display: none; }
            
            input, select { display: none !important; }
            .print-value-display { display: inline-block !important; }
            .input-desc-edit { display: none !important; }
            .print-desc-display { display: inline-block !important; width: 100%; }
            
            .bill-grid-header { border-bottom: 2px solid #000 !important; }
            .bill-grid-row { border-bottom: 1px solid #eee !important; }
            
            /* Enhanced Footer Positioning for Print */
            footer { 
                position: fixed; 
                bottom: 0; 
                left: 0; 
                right: 0; 
                text-align: center; 
                font-size: 8pt; 
                color: black !important; 
                border-top: 1px solid #000; 
                padding-top: 8px; 
                background: white;
                z-index: 100;
            }
            
            .p-8 { padding: 1.5rem !important; }
            .mb-6 { margin-bottom: 1rem !important; }
            .gap-8 { gap: 1rem !important; }
            
            #financialSummarySection .text-lg, #financialSummarySection .text-2xl, #financialSummarySection .text-base { font-size: 10pt !important; }
            
            /* Ensure signature doesn't overlap footer */
            #signatureSection { margin-bottom: 50px !important; } 
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen">

    <!-- NAVIGATION BAR (No Print) -->
    <div class="w-full bg-white shadow-sm border-b border-gray-200 no-print sticky top-0 z-10">
        <div class="max-w-[210mm] mx-auto px-4 flex justify-between items-center">
            <div class="font-black text-[#1e3a8a] text-lg py-3">KCC BILLING</div>
            <div class="flex gap-4">
                <div class="nav-tab active" onclick="switchView('billing')" id="tab-billing">Billing</div>
                <div class="nav-tab" onclick="switchView('history')" id="tab-history">History</div>
                <div class="nav-tab" onclick="switchView('tariff')" id="tab-tariff">Tariff Master</div>
            </div>
            <div class="text-xs text-gray-500 font-bold" id="authStatus">Initializing...</div>
        </div>
    </div>

    <!-- VIEW: BILLING (Main A4 Page) -->
    <div id="view-billing" class="container-main shadow-lg rounded-sm flex flex-col relative mb-10">
        
        <!-- HEADER -->
        <header class="p-8 pb-2">
            <div class="flex justify-between items-start">
                <div class="flex items-center gap-4">
                    <!-- HOSPITAL LOGO -->
                    <div class="w-16 h-16 flex items-center justify-center">
                        <img src="logo.png" alt="Logo" class="max-w-full max-h-full object-contain" onerror="this.style.display='none'; this.parentElement.innerHTML='<span class=\'text-xs font-bold text-gray-400\'>LOGO</span>'">
                    </div>
                    <div>
                        <h1 class="text-2xl font-black text-gray-900 tracking-tight leading-none">KRISHNA KIDNEY CENTRE</h1>
                        <p class="text-sm text-gray-500 mt-1 font-medium">Krishnagiri, Tamil Nadu • India</p>
                    </div>
                </div>
                <div class="text-right">
                    <span class="inline-block bg-blue-600 text-white text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wider mb-2 print:bg-white print:text-black print:border print:border-black">
                        Discharge Final Bill
                    </span>
                    <div class="text-sm">Bill No: <span id="b_invoice_no" class="font-bold text-red-600">PROVISIONAL</span></div>
                    <div class="text-sm text-gray-500">Run Date: <span id="b_run_date" class="font-medium text-gray-900"></span></div>
                </div>
            </div>
            <hr class="mt-4 border-gray-200">
        </header>

        <!-- CONTROLS (Screen Only) -->
        <div class="px-8 mb-2 no-print flex gap-2">
            <button onclick="generateNewIDs()" class="bg-amber-500 hover:bg-amber-600 text-white text-xs font-bold px-3 py-2 rounded">GENERATE NEW ID</button>
            <button onclick="newBill()" class="bg-red-500 hover:bg-red-600 text-white text-xs font-bold px-3 py-2 rounded">CLEAR FORM</button>
            <div class="ml-auto text-xs text-gray-400 self-center hidden" id="saveStatus">Saved</div>
        </div>

        <!-- PATIENT DETAILS SECTION -->
        <div class="px-8 mb-4">
            <div class="section-header rounded-t-sm">Patient & General Details</div>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-x-8 gap-y-2 p-3 border border-t-0 border-gray-200 text-xs">
                <!-- Row 1 -->
                <div>
                    <label class="block text-[9px] font-bold text-gray-400 uppercase tracking-wider mb-1">UHID</label>
                    <input type="text" id="ui_uhid" class="no-print-border" oninput="renderUI()">
                    <span class="print-value-display hidden font-bold text-gray-800" id="print_uhid"></span>
                </div>
                <div>
                    <label class="block text-[9px] font-bold text-gray-400 uppercase tracking-wider mb-1">IP Number</label>
                    <input type="text" id="ui_ip" class="no-print-border" oninput="renderUI()">
                    <span class="print-value-display hidden font-bold text-gray-800" id="print_ip"></span>
                </div>
                <div>
                    <label class="block text-[9px] font-bold text-gray-400 uppercase tracking-wider mb-1">Patient Name</label>
                    <input type="text" id="ui_name" class="font-bold" oninput="renderUI()">
                    <span class="print-value-display hidden font-bold text-gray-800 text-sm" id="print_name"></span>
                </div>

                <!-- Row 2 -->
                <div>
                    <label class="block text-[9px] font-bold text-gray-400 uppercase tracking-wider mb-1">Admission Date</label>
                    <input type="date" id="ui_doa" oninput="renderUI()">
                    <span class="print-value-display hidden font-medium text-gray-800" id="print_doa"></span>
                </div>
                <div>
                    <label class="block text-[9px] font-bold text-gray-400 uppercase tracking-wider mb-1">Discharge Date</label>
                    <input type="date" id="ui_dod" oninput="renderUI()">
                    <span class="print-value-display hidden font-medium text-gray-800" id="print_dod"></span>
                </div>
                <div>
                    <label class="block text-[9px] font-bold text-gray-400 uppercase tracking-wider mb-1">Room Category</label>
                    <select id="ui_roomCat" onchange="renderUI()"></select>
                    <span class="print-value-display hidden font-medium text-gray-800" id="print_roomCat"></span>
                    <button onclick="addRoomDays()" class="no-print mt-1 text-[9px] text-blue-600 underline hover:text-blue-800">Auto-Calc</button>
                </div>

                <!-- Row 3 -->
                <div>
                    <label class="block text-[9px] font-bold text-gray-400 uppercase tracking-wider mb-1">Consultant</label>
                    <select id="ui_doc" onchange="renderUI()"></select>
                    <span class="print-value-display hidden font-medium text-gray-800" id="print_doc"></span>
                </div>
                <div>
                    <label class="block text-[9px] font-bold text-gray-400 uppercase tracking-wider mb-1">Insurance / Payer</label>
                    <input type="text" id="ui_insurance" oninput="renderUI()">
                    <span class="print-value-display hidden font-medium text-gray-800" id="print_insurance"></span>
                </div>
            </div>
        </div>

        <!-- BILLING ITEMS TABLE -->
        <div class="px-8 flex-grow">
            <div class="section-header rounded-t-sm">Billing Items</div>
            
            <div class="bill-grid-header bg-gray-50">
                <div class="text-left-col">S.No</div>
                <div class="text-left-col">Date</div>
                <div class="text-left-col">Description</div>
                <div class="text-right-col">Rate</div>
                <div class="text-right-col">Qty</div>
                <div class="text-right-col">Disc.</div>
                <div class="text-right-col">Total</div>
                <div class="text-center no-print">Act</div>
            </div>

            <div id="ui_billBody" class="border-l border-r border-b border-gray-200 min-h-[150px] pb-4">
                <!-- JS will inject rows here -->
            </div>

            <!-- MANUAL ADD (No Print) -->
            <div class="no-print mt-2 p-2 bg-blue-50 border border-blue-100 rounded text-xs">
                <div class="flex gap-2 items-end">
                    <div class="flex-1">
                        <label class="text-[9px] text-gray-500 font-bold uppercase">Category</label>
                        <select id="ui_cat" class="bg-white"></select>
                    </div>
                    <div class="flex-[2]">
                        <label class="text-[9px] text-gray-500 font-bold uppercase">Description</label>
                        <input type="text" id="ui_desc" class="bg-white" placeholder="Type or Select..." list="desc_list">
                        <datalist id="desc_list"></datalist>
                    </div>
                    <div class="w-16">
                        <label class="text-[9px] text-gray-500 font-bold uppercase">Rate</label>
                        <input type="number" id="ui_rate" class="bg-white">
                    </div>
                    <div class="w-12">
                        <label class="text-[9px] text-gray-500 font-bold uppercase">Qty</label>
                        <input type="number" id="ui_qty" value="1" class="bg-white">
                    </div>
                    <button onclick="addItem()" class="bg-blue-600 text-white font-bold text-xs px-3 py-1.5 rounded">ADD</button>
                    <button onclick="clearBillingItems()" class="bg-white border border-red-200 text-red-600 font-bold text-xs px-2 py-1.5 rounded">CLR</button>
                </div>
            </div>
        </div>

        <!-- SUMMARY SECTION -->
        <div class="px-8 mt-2 mb-20" id="financialSummarySection">
            <div class="grid grid-cols-2 gap-8">
                <!-- LEFT: Receipts -->
                <div>
                    <div class="section-header rounded-t-sm">Receipts & Payments</div>
                    <div class="border border-t-0 border-gray-200 p-3 min-h-[100px] flex flex-col justify-between">
                        <div id="receiptLines" class="space-y-1 text-xs"></div>
                        <div class="no-print mt-2 pt-2 border-t border-dashed border-gray-200">
                            <div class="flex gap-2 mb-2">
                                <input type="text" id="ui_rno" placeholder="R.No" class="w-20">
                                <input type="number" id="ui_ramt" placeholder="Amount" class="w-24 font-bold text-blue-800">
                                <input type="date" id="ui_rdate" class="w-24">
                            </div>
                            <div class="flex gap-2">
                                <select id="ui_rmode" class="w-20"><option>Cash</option><option>Card</option><option>UPI</option></select>
                                <button onclick="addReceipt()" class="bg-green-600 text-white text-xs font-bold px-3 py-1 rounded flex-grow">ADD PAYMENT</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT: Financial Summary -->
                <div>
                    <div class="section-header rounded-t-sm">Financial Summary</div>
                    <div class="border border-t-0 border-gray-200 p-3">
                        <div class="flex justify-between items-center mb-1 no-print">
                            <span class="text-xs text-gray-500">Global Discount (%)</span>
                            <input type="number" id="ui_billDiscount" value="0" class="w-16 text-right font-bold text-red-600" oninput="renderUI()">
                        </div>

                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600 font-bold">Total Gross Amount</span>
                                <span class="font-bold font-mono" id="ui_s_gross">0.00</span>
                            </div>
                            <!-- Hidden rows -->
                            <div class="flex justify-between text-red-600 text-xs hidden">
                                <span>Item Discounts</span>
                                <span class="font-mono" id="ui_itemDiscount">- 0.00</span>
                            </div>
                            <div class="flex justify-between text-red-600 text-xs border-b border-gray-100 pb-2 hidden">
                                <span>Global Discount Applied</span>
                                <span class="font-mono" id="ui_globalDiscount">- 0.00</span>
                            </div>
                            <div class="flex justify-between items-center pt-1 border-t border-gray-100">
                                <span class="font-bold text-gray-800">Final Bill Amount</span>
                                <span class="font-bold font-mono text-base" id="ui_s_net_bill">0.00</span>
                            </div>
                            <div class="hidden flex justify-between items-center bg-gray-50 p-2 rounded border border-gray-200 mt-2">
                                <span class="font-black text-gray-900 uppercase">**Grand Total**</span>
                                <span class="font-black font-mono text-lg text-gray-900" id="ui_s_grand_total">0.00</span>
                            </div>
                            <div class="hidden flex justify-between text-gray-600 pt-2">
                                <span>Less: Receipts Paid</span>
                                <span class="font-mono" id="ui_s_rec">0.00</span>
                            </div>
                            <!-- Balance Due -->
                            <div class="flex justify-between items-center pt-2 border-t-2 border-gray-300 mt-2">
                                <span class="font-black text-red-600 text-lg uppercase">Balance Due</span>
                                <span class="font-black font-mono text-2xl text-red-600" id="ui_s_final">0.00</span>
                            </div>
                        </div>
                        
                        <div class="mt-4 flex gap-2 justify-end no-print">
                            <button onclick="saveBill()" class="bg-green-600 text-white font-bold px-4 py-2 rounded shadow hover:bg-green-700 transition flex items-center gap-2 justify-center text-xs">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                                SAVE
                            </button>
                            <button onclick="preparePrint()" class="bg-[#1e3a8a] text-white font-bold px-4 py-2 rounded shadow hover:bg-blue-900 transition flex items-center gap-2 justify-center text-xs">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2z"></path></svg>
                                PRINT FINAL INVOICE
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SIGNATURE SECTION -->
        <div class="px-8 mt-auto mb-4" id="signatureSection">
            <div class="flex justify-between items-end pt-8 pb-4">
                <div class="text-center">
                    <div class="w-40 border-t border-black mb-1"></div>
                    <div class="font-bold text-xs uppercase">Prepared By</div>
                </div>
                <div class="text-center">
                    <div class="w-40 border-t border-black mb-1"></div>
                    <div class="font-bold text-xs uppercase">Staff Signature</div>
                </div>
            </div>
        </div>

        <!-- FOOTER -->
        <footer class="py-4 border-t border-gray-200 text-center text-gray-500 text-[9px]">
            <div class="font-bold text-gray-700 uppercase mb-1">Krishna Kidney Centre</div>
            <div>123 Main Street, Near Bus Stand, Krishnagiri - 635001, Tamil Nadu, India</div>
            <div>Phone: +91 4343-22XXXX | Email: info@krishnakidneycentre.com</div>
            <div class="mt-1 text-gray-400 italic">This is a computer generated invoice. Signature is not required.</div>
        </footer>

    </div>

    <!-- VIEW: HISTORY -->
    <div id="view-history" class="container-main hidden bg-white shadow p-8 min-h-screen">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Bill History</h2>
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr>
                        <th class="px-6 py-3">Date</th>
                        <th class="px-6 py-3">Bill No</th>
                        <th class="px-6 py-3">Patient Name</th>
                        <th class="px-6 py-3 text-right">Amount</th>
                        <th class="px-6 py-3 text-center">Action</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- VIEW: TARIFF MASTER -->
    <div id="view-tariff" class="container-main hidden bg-white shadow p-8 min-h-screen">
        <div class="flex justify-between items-center mb-6 border-b pb-2">
            <h2 class="text-2xl font-bold text-gray-800">Tariff Master</h2>
            <button onclick="openAddTariffModal()" class="bg-blue-600 text-white px-4 py-2 rounded text-xs font-bold">+ ADD ITEM</button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="tariffGrid"></div>
    </div>

    <!-- TARIFF ADD/EDIT MODAL -->
    <div id="tariffAddModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded shadow-lg w-96">
            <h3 class="font-bold mb-4" id="tm_title">Add Tariff Item</h3>
            <input id="tm_category" class="mb-2 border p-2 w-full text-xs" placeholder="Category (e.g. SURGEON FEES)">
            <input id="tm_description" class="mb-2 border p-2 w-full text-xs" placeholder="Description">
            <input id="tm_rate" type="number" class="mb-4 border p-2 w-full text-xs" placeholder="Rate">
            <!-- Hidden index for editing -->
            <input type="hidden" id="tm_edit_index" value="-1">
            <input type="hidden" id="tm_edit_cat" value="">
            
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('tariffAddModal').classList.add('hidden')" class="px-3 py-1 bg-gray-200 rounded text-xs">Cancel</button>
                <button onclick="saveTariffItem()" class="px-3 py-1 bg-blue-600 text-white rounded text-xs">Save</button>
            </div>
        </div>
    </div>

    <!-- --- JAVASCRIPT LOGIC --- -->
    <script type="module">
        // Import Firebase (will fail gracefully if offline/not configured)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // GLOBAL STATE
        window.billItems = [];
        window.receipts = [];
        window.currentBillId = null;
        let isOnline = false;
        let db, auth, appId;
        let currentUser = null;

        // DEFAULT DATA (Fallback)
        let localTariff = {
            "SURGEON FEES": [], "ASSISTANT SURGEON FEES": [], "DJ STENTING": [], "ANAESTHESIA FEES": [],
            "ICU CHARGE": [], "DOCTOR CHARGE": [], "SPECIALTY DOCTOR ICU VISIT CHARGE": [], "BED CHARGE": [],
            "NURSING CHARGES": [], "OT CHARGE": [], "PREANESTHETIC CHECKUP": [], "MEDICINE CHARGE": [],
            "ROOM RENT": [], "MISC": []
        };

        // --- 1. INITIALIZATION & AUTH HANDLER ---
        async function initApp() {
            const statusEl = document.getElementById('authStatus');
            try {
                if (typeof __firebase_config === 'undefined' || !__firebase_config) {
                    throw new Error("Local Mode");
                }
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    if (user) {
                        isOnline = true;
                        statusEl.innerText = "Online (Cloud)";
                        statusEl.className = "text-xs text-green-600 font-bold";
                        loadTariffFromCloud();
                        loadHistoryFromCloud();
                    }
                });
            } catch (e) {
                console.log("Running in Offline/Local Mode");
                isOnline = false;
                statusEl.innerText = "Offline (Local)";
                statusEl.className = "text-xs text-amber-600 font-bold";
                loadLocalData();
            }
            
            // Ensure UI is ready regardless of connection
            updateDropdowns();
            renderTariffMasterUI();
            generateNewIDs();
            renderUI();
        }

        // --- 2. DATA LOADING (HYBRID) ---
        function loadLocalData() {
            const storedTariff = localStorage.getItem('kcc_tariff');
            if(storedTariff) localTariff = JSON.parse(storedTariff);
            
            const storedBills = localStorage.getItem('kcc_bills');
            if(storedBills) {
                renderHistoryTable(JSON.parse(storedBills));
            }
        }

        function saveLocalData() {
            localStorage.setItem('kcc_tariff', JSON.stringify(localTariff));
        }

        // --- 3. CORE FUNCTIONS EXPORTED TO WINDOW ---
        // Decimal Wrapper
        if (typeof Decimal === 'undefined') {
            window.Decimal = class {
                constructor(value) { this.v = Number(value || 0); }
                toNumber() { return this.v; }
                plus(other) { return new Decimal(this.v + new Decimal(other).toNumber()); }
                mul(other) { return new Decimal(this.v * new Decimal(other).toNumber()); }
                div(other) { return new Decimal(this.v / new Decimal(other).toNumber()); }
                minus(other) { return new Decimal(this.v - new Decimal(other).toNumber()); }
                lte(other) { return this.v <= new Decimal(other).toNumber(); }
                gt(other) { return this.v > new Decimal(other).toNumber(); }
                toFixed(d) { return this.v.toFixed(d); }
            };
        } else { window.Decimal = Decimal; }

        window.formatMoney = (amount) => new Decimal(amount).toFixed(2);
        window.formatDate = (dateStr) => {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }).toUpperCase();
        };
        window.generateUniqueBillNo = () => {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 12; i++) { result += chars.charAt(Math.floor(Math.random() * chars.length)); }
            return result;
        };

        // --- 4. BILLING LOGIC ---
        window.generateNewIDs = () => {
            window.currentBillId = null;
            document.getElementById('ui_uhid').value = "KCC" + Math.floor(Math.random() * 10000);
            document.getElementById('ui_ip').value = "IP" + Math.floor(Math.random() * 10000);
            document.getElementById('b_invoice_no').innerText = window.generateUniqueBillNo();
            renderUI();
        };

        window.addItem = () => {
            const cat = document.getElementById('ui_cat').value;
            const desc = document.getElementById('ui_desc').value;
            const rate = document.getElementById('ui_rate').value;
            const qty = document.getElementById('ui_qty').value;
            const date = document.getElementById('ui_dod').value; 
            if(!rate || !qty) return;
            window.billItems.push({ category: cat, desc: desc, rate: rate, qty: qty, date: date, discount: 0 });
            renderUI();
        };

        window.calculateTotals = () => {
            let gross = new Decimal(0);
            let totalItemDisc = new Decimal(0);
            let netAfterItemDisc = new Decimal(0);

            window.billItems.forEach(item => {
                const g = new Decimal(item.rate).mul(item.qty);
                const d = new Decimal(item.discount || 0);
                item.gross = g.toFixed(2);
                item.total = g.minus(d).toFixed(2);
                gross = gross.plus(g);
                totalItemDisc = totalItemDisc.plus(d);
                netAfterItemDisc = netAfterItemDisc.plus(g.minus(d));
            });

            const globalDiscPercent = new Decimal(document.getElementById('ui_billDiscount').value || 0);
            let globalDiscVal = new Decimal(0);
            if(globalDiscPercent.gt(0)) globalDiscVal = netAfterItemDisc.mul(globalDiscPercent.div(100));

            const finalBill = netAfterItemDisc.minus(globalDiscVal);
            let totalPaid = new Decimal(0);
            window.receipts.forEach(r => totalPaid = totalPaid.plus(r.amount));
            const balance = finalBill.minus(totalPaid);

            document.getElementById('ui_s_gross').innerText = formatMoney(gross.toNumber());
            document.getElementById('ui_itemDiscount').innerText = "- " + formatMoney(totalItemDisc.toNumber());
            document.getElementById('ui_globalDiscount').innerText = "- " + formatMoney(globalDiscVal.toNumber());
            document.getElementById('ui_s_net_bill').innerText = formatMoney(finalBill.toNumber());
            document.getElementById('ui_s_grand_total').innerText = formatMoney(finalBill.toNumber());
            document.getElementById('ui_s_rec').innerText = formatMoney(totalPaid.toNumber());
            document.getElementById('ui_s_final').innerText = formatMoney(balance.toNumber());
        };

        window.renderUI = () => {
            // Update Headers
            const fields = ['uhid', 'ip', 'name', 'doa', 'dod', 'roomCat', 'doc', 'insurance'];
            fields.forEach(f => {
                const val = document.getElementById('ui_' + f).value;
                const display = document.getElementById('print_' + f);
                if (display) display.innerText = (f === 'doa' || f === 'dod') ? window.formatDate(val) : val;
            });
            document.getElementById('b_run_date').innerText = window.formatDate(document.getElementById('ui_dod').value);

            // Render Rows
            const tbody = document.getElementById('ui_billBody');
            tbody.innerHTML = '';
            const sortedItems = [...window.billItems].sort((a, b) => a.category.localeCompare(b.category) || a.date.localeCompare(b.date));
            let currentCat = null;
            let sno = 1;

            sortedItems.forEach((item, idx) => {
                if (item.category !== currentCat) {
                    currentCat = item.category;
                    tbody.innerHTML += `<div class="category-row">${currentCat}</div>`;
                }
                const originalIdx = window.billItems.indexOf(item);
                const row = document.createElement('div');
                row.className = 'bill-grid-row group hover:bg-blue-50';
                row.innerHTML = `
                    <div class="text-left-col text-gray-500">${sno++}</div>
                    <div class="text-left-col">${window.formatDate(item.date)}</div>
                    <div class="text-left-col">
                        <input type="text" class="input-desc-edit" value="${item.desc}" onchange="updateItemDesc(${originalIdx}, this.value)">
                        <span class="print-desc-display hidden">${item.desc}</span>
                    </div>
                    <div class="text-right-col">${parseFloat(item.rate).toFixed(2)}</div>
                    <div class="text-right-col">${item.qty}</div>
                    <div class="text-right-col">
                        <input type="number" class="input-financial w-full h-6 text-xs no-print" value="${item.discount}" onchange="updateItemDisc(${originalIdx}, this.value)">
                        <span class="print-value-display hidden">${item.discount > 0 ? item.discount : '-'}</span>
                    </div>
                    <div class="text-right-col font-bold text-gray-900">${item.total}</div>
                    <div class="text-center no-print">
                        <button onclick="deleteItem(${originalIdx})" class="text-red-400 hover:text-red-600 font-bold">×</button>
                    </div>
                `;
                tbody.appendChild(row);
            });

            // Render Receipts
            const rContainer = document.getElementById('receiptLines');
            rContainer.innerHTML = window.receipts.map((r, i) => `
                <div class="flex justify-between border-b border-dashed border-gray-200 py-1">
                    <span>${r.no} <span class="text-gray-400 text-[10px]">(${window.formatDate(r.date)})</span> <span class="bg-gray-100 px-1 rounded text-[10px]">${r.mode}</span></span>
                    <span class="font-bold">₹${r.amount} <button onclick="deleteReceipt(${i})" class="ml-2 text-red-500 no-print">×</button></span>
                </div>
            `).join('');

            window.calculateTotals();
        };

        // UI Helpers
        window.updateItemDisc = (idx, val) => { window.billItems[idx].discount = val; renderUI(); };
        window.updateItemDesc = (idx, val) => { window.billItems[idx].desc = val; };
        window.deleteItem = (idx) => { window.billItems.splice(idx, 1); renderUI(); };
        window.addReceipt = () => {
            const rno = document.getElementById('ui_rno').value;
            const amt = document.getElementById('ui_ramt').value;
            const date = document.getElementById('ui_rdate').value;
            const mode = document.getElementById('ui_rmode').value;
            if(!amt || !rno) return;
            window.receipts.push({ no: rno, amount: parseFloat(amt), date: date, mode: mode });
            document.getElementById('ui_ramt').value = '';
            renderUI();
        };
        window.deleteReceipt = (idx) => { window.receipts.splice(idx, 1); renderUI(); };
        
        window.addRoomDays = () => {
            const roomType = document.getElementById('ui_roomCat').value;
            const start = new Date(document.getElementById('ui_doa').value);
            const end = new Date(document.getElementById('ui_dod').value);
            if(isNaN(start) || isNaN(end)) return alert("Set Dates first");
            let tariff = 2000, nursing = 500, doc = 500;
            if(roomType.includes("PVT")) { tariff=4000; nursing=1000; doc=1000; }
            if(roomType.includes("ICU")) { tariff=6000; nursing=2000; doc=2000; }
            if(roomType.includes("AC")) { tariff=3500; nursing=750; doc=800; }
            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
            for(let i=0; i < days; i++) {
                let d = new Date(start); d.setDate(d.getDate() + i);
                const dateStr = d.toISOString().split('T')[0];
                window.billItems.push(
                    { category: "ROOM RENT", desc: `Room: ${roomType}`, rate: tariff, qty: 1, date: dateStr, discount: 0 },
                    { category: "NURSING CHARGES", desc: "Nursing Charges", rate: nursing, qty: 1, date: dateStr, discount: 0 },
                    { category: "DOCTOR CHARGE", desc: "Consultant Visit", rate: doc, qty: 1, date: dateStr, discount: 0 }
                );
            }
            renderUI();
        };

        window.newBill = () => {
            if(confirm("Reset form?")) {
                window.billItems = []; window.receipts = []; window.currentBillId = null;
                document.querySelectorAll('input').forEach(i => i.value = '');
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('ui_doa').value = today;
                document.getElementById('ui_dod').value = today;
                document.getElementById('ui_rdate').value = today;
                renderUI();
                generateNewIDs();
            }
        };
        
        window.preparePrint = () => {
            const name = document.getElementById('ui_name').value || "Patient";
            const billNo = document.getElementById('b_invoice_no').innerText || "Bill";
            document.title = `${name}_${billNo}`;
            setTimeout(() => window.print(), 100);
        };
        
        window.clearBillingItems = () => { window.billItems = []; renderUI(); };

        // --- 5. TARIFF LOGIC ---
        window.openAddTariffModal = () => {
            document.getElementById('tariffAddModal').classList.remove('hidden');
            document.getElementById('tm_title').innerText = "Add Tariff Item";
            document.getElementById('tm_category').value = "";
            document.getElementById('tm_description').value = "";
            document.getElementById('tm_rate').value = "";
            document.getElementById('tm_edit_index').value = "-1";
        }
        
        window.openEditTariffModal = (cat, idx) => {
            document.getElementById('tariffAddModal').classList.remove('hidden');
            const item = localTariff[cat][idx];
            document.getElementById('tm_title').innerText = "Edit Item";
            document.getElementById('tm_category').value = cat;
            document.getElementById('tm_description').value = item.name;
            document.getElementById('tm_rate').value = item.rate;
            document.getElementById('tm_edit_index').value = idx;
            document.getElementById('tm_edit_cat').value = cat;
        }

        window.saveTariffItem = async () => {
            const cat = document.getElementById('tm_category').value.toUpperCase();
            const desc = document.getElementById('tm_description').value;
            const rate = parseFloat(document.getElementById('tm_rate').value);
            const idx = parseInt(document.getElementById('tm_edit_index').value);
            const oldCat = document.getElementById('tm_edit_cat').value;

            if(!cat || !desc) return;
            if(!localTariff[cat]) localTariff[cat] = [];

            if(idx > -1 && oldCat === cat) {
                localTariff[cat][idx] = { name: desc, rate: rate };
            } else {
                if(idx > -1 && oldCat !== cat) localTariff[oldCat].splice(idx, 1);
                localTariff[cat].push({ name: desc, rate: rate });
            }

            if(isOnline) {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tariff', 'master'), localTariff);
            } else {
                saveLocalData();
                updateDropdowns();
                renderTariffMasterUI();
            }
            document.getElementById('tariffAddModal').classList.add('hidden');
        };

        window.deleteTariffItem = async (cat, idx) => {
            if(confirm("Delete item?")) {
                localTariff[cat].splice(idx, 1);
                if(isOnline) await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tariff', 'master'), localTariff);
                else { saveLocalData(); renderTariffMasterUI(); updateDropdowns(); }
            }
        };

        // --- 6. SAVING LOGIC ---
        window.saveBill = async () => {
            const billData = {
                uhid: document.getElementById('ui_uhid').value,
                ip: document.getElementById('ui_ip').value,
                name: document.getElementById('ui_name').value,
                doa: document.getElementById('ui_doa').value,
                dod: document.getElementById('ui_dod').value,
                roomCat: document.getElementById('ui_roomCat').value,
                doc: document.getElementById('ui_doc').value,
                insurance: document.getElementById('ui_insurance').value,
                billNo: document.getElementById('b_invoice_no').innerText,
                billDiscount: document.getElementById('ui_billDiscount').value,
                items: window.billItems,
                receipts: window.receipts,
                updatedAt: new Date().toISOString()
            };

            const statusEl = document.getElementById('saveStatus');
            statusEl.innerText = "Saving...";
            statusEl.classList.remove('hidden');

            if(isOnline) {
                try {
                    if (window.currentBillId) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'bills', window.currentBillId), billData);
                    } else {
                        const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'bills'), billData);
                        window.currentBillId = docRef.id;
                    }
                    statusEl.innerText = "Saved to Cloud";
                } catch(e) { console.error(e); alert("Cloud Save Error"); }
            } else {
                // Local Storage Saving
                let bills = JSON.parse(localStorage.getItem('kcc_bills') || '[]');
                if(window.currentBillId) {
                    const idx = bills.findIndex(b => b.id === window.currentBillId);
                    if(idx > -1) bills[idx] = { ...billData, id: window.currentBillId };
                } else {
                    const newId = 'local_' + Date.now();
                    window.currentBillId = newId;
                    bills.push({ ...billData, id: newId });
                }
                localStorage.setItem('kcc_bills', JSON.stringify(bills));
                statusEl.innerText = "Saved Locally";
                loadLocalData(); // Refresh history
            }
            setTimeout(() => statusEl.classList.add('hidden'), 2000);
        };

        // --- 7. LOADERS & RENDERERS ---
        const loadTariffFromCloud = () => {
            const tariffRef = doc(db, 'artifacts', appId, 'public', 'data', 'tariff', 'master');
            onSnapshot(tariffRef, (docSnap) => {
                if (docSnap.exists()) localTariff = docSnap.data();
                else setDoc(tariffRef, localTariff);
                updateDropdowns();
                renderTariffMasterUI();
            });
        };

        const loadHistoryFromCloud = () => {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'bills'), (snapshot) => {
                const bills = [];
                snapshot.forEach(doc => bills.push({ ...doc.data(), id: doc.id }));
                renderHistoryTable(bills);
            });
        };

        const renderHistoryTable = (bills) => {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';
            bills.forEach(d => {
                const total = d.items ? d.items.reduce((acc, item) => acc + (item.rate * item.qty - (item.discount||0)), 0) : 0;
                const tr = document.createElement('tr');
                tr.className = "bg-white border-b hover:bg-gray-50 cursor-pointer";
                tr.innerHTML = `
                    <td class="px-6 py-4">${window.formatDate(d.updatedAt.split('T')[0])}</td>
                    <td class="px-6 py-4 font-mono font-bold">${d.billNo}</td>
                    <td class="px-6 py-4 font-bold text-gray-900">${d.name}</td>
                    <td class="px-6 py-4 text-right">₹${total.toFixed(2)}</td>
                    <td class="px-6 py-4 text-center"><button class="text-blue-600 hover:underline">Edit</button></td>
                `;
                tr.onclick = () => {
                    window.currentBillId = d.id;
                    window.billItems = d.items || [];
                    window.receipts = d.receipts || [];
                    document.getElementById('ui_uhid').value = d.uhid;
                    document.getElementById('ui_ip').value = d.ip;
                    document.getElementById('ui_name').value = d.name;
                    document.getElementById('ui_doa').value = d.doa;
                    document.getElementById('ui_dod').value = d.dod;
                    document.getElementById('ui_roomCat').value = d.roomCat;
                    document.getElementById('ui_doc').value = d.doc;
                    document.getElementById('ui_insurance').value = d.insurance;
                    document.getElementById('b_invoice_no').innerText = d.billNo;
                    document.getElementById('ui_billDiscount').value = d.billDiscount || 0;
                    switchView('billing');
                    renderUI();
                };
                tbody.appendChild(tr);
            });
        };

        const updateDropdowns = () => {
            const catSel = document.getElementById('ui_cat');
            const roomSel = document.getElementById('ui_roomCat');
            const currentVal = catSel.value;
            catSel.innerHTML = '';
            Object.keys(localTariff).forEach(k => {
                const opt = document.createElement('option');
                opt.value = k; opt.text = k; catSel.add(opt);
            });
            if(currentVal) catSel.value = currentVal;

            roomSel.innerHTML = '';
            ["GENERAL WARD", "SINGLE AC", "GW", "PVT", "ICU"].forEach(r => {
                const opt = document.createElement('option');
                opt.value = r; opt.text = r; roomSel.add(opt);
            });
        };

        const renderTariffMasterUI = () => {
            const grid = document.getElementById('tariffGrid');
            grid.innerHTML = '';
            Object.keys(localTariff).forEach(cat => {
                const card = document.createElement('div');
                card.className = "border rounded p-4 shadow-sm bg-gray-50";
                let listHtml = '';
                localTariff[cat].forEach((item, idx) => {
                    listHtml += `
                        <div class="flex justify-between items-center text-xs py-1 border-b border-gray-200">
                            <span>${item.name}</span>
                            <div class="flex items-center gap-2">
                                <span class="font-bold">₹${item.rate}</span>
                                <button onclick="openEditTariffModal('${cat}', ${idx})" class="text-blue-500 hover:text-blue-700">✎</button>
                                <button onclick="deleteTariffItem('${cat}', ${idx})" class="text-red-500 hover:text-red-700">×</button>
                            </div>
                        </div>
                    `;
                });
                card.innerHTML = `<h4 class="font-bold text-[#1e3a8a] mb-2 border-b pb-1">${cat}</h4><div class="max-h-40 overflow-y-auto">${listHtml}</div>`;
                grid.appendChild(card);
            });
        };

        // --- 8. UI HELPERS ---
        window.switchView = (view) => {
            ['billing', 'history', 'tariff'].forEach(v => {
                document.getElementById('view-' + v).classList.add('hidden');
                document.getElementById('tab-' + v).classList.remove('active');
            });
            document.getElementById('view-' + view).classList.remove('hidden');
            document.getElementById('tab-' + view).classList.add('active');
        };

        document.getElementById('ui_cat').addEventListener('change', (e) => {
            const cat = e.target.value;
            document.getElementById('ui_desc').value = cat;
            const items = localTariff[cat] || [];
            const list = document.getElementById('desc_list');
            list.innerHTML = '';
            items.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.name;
                list.appendChild(opt);
            });
        });

        document.getElementById('ui_desc').addEventListener('input', (e) => {
            const val = e.target.value;
            const cat = document.getElementById('ui_cat').value;
            const items = localTariff[cat] || [];
            const match = items.find(i => i.name === val);
            if(match) document.getElementById('ui_rate').value = match.rate;
        });

        const docSel = document.getElementById('ui_doc');
        ["Dr. B.K. Srinivasan", "Dr. Rajesh", "Dr. Anjali"].forEach(d => {
            const opt = document.createElement('option');
            opt.value = d; opt.text = d; docSel.add(opt);
        });

        const today = new Date().toISOString().split('T')[0];
        document.getElementById('ui_doa').value = today;
        document.getElementById('ui_dod').value = today;
        document.getElementById('ui_rdate').value = today;

        // START APP
        initApp();

    </script>
</body>
</html>
